---
title: "Project A – Task B: HDL & Food Security Dashboard"
format:
  html:
    theme: cosmo
    toc: true
page-layout: full
execute:
  echo: false
  warning: false
  message: false
---
## 0) Setup (Packages and Data Wiring)
```{r}
#| label: setup
#| include: false
#| message: false
#| warning: false
# Packages for dashboard

library(readxl)       # read_excel()
library(dplyr)
library(gt)           # nice tables
library(ggplot2)
library(here)

has_col <- function(df, nm) nm %in% names(df)
fallback <- function(x, alt) if (!is.null(x) && length(x) && !is.na(x)) x else alt

```


```{r}
#| label: load excel
#| echo: false
#| warning: false


excel_path <- here::here("outputs/tables/dashboard_tables.xlsx")
stopifnot(file.exists(excel_path))

# Required sheets produced by scripts/03_summarize_export.R
overall <- readxl::read_excel(excel_path, sheet = "Overall")
by_educ <- readxl::read_excel(excel_path, sheet = "HDL by Education")

# Optional Food Security sheet: render only if present
available_sheets <- readxl::excel_sheets(excel_path)
has_fsq_sheet <- "HDL by Food Security" %in% available_sheets
if (has_fsq_sheet) {
  by_fsq <- readxl::read_excel(excel_path, sheet = "HDL by Food Security")
}

# KPIs 
kpi_n        <- if (has_col(overall, "sample_n")) overall$sample_n[1] else overall$n[1]
kpi_hdl_n    <- if (has_col(overall, "hdl_n"))     overall$hdl_n[1]     else NA
kpi_mean_hdl <- round(overall$mean_hdl[1], 1)
kpi_sd_hdl   <- round(overall$sd_hdl[1],   1)

# Order education for nicer displays 
educ_levels <- c("LessHS","HS/GED","SomeCollege","College+")
if (has_col(by_educ, "educ4")) {
  by_educ <- by_educ |>
    mutate(educ4 = factor(educ4, levels = educ_levels))
}

```

## Task B — Subpopulation & Data Files Used 

This dashboard uses three NHANES files (2017–Mar 2020 pre-pandemic):

Demographics (P_DEMO)

HDL Laboratory (P_HDL)

Food Security (P_FSQ)

We restrict to: RIDSTATR = “Both interviewed and MEC examined”, ages 21–79.
Results shown here are unweighted for this assignment.

## Task B — Adequate Ns 

::: {.columns}
::: {.column width="25%"}
Sample size (21–79, MEC)
```{r}
format(kpi_n, big.mark=",")
```
:::
::: {.column width="25%"}
With HDL
```{r}
if (!is.na(kpi_hdl_n)) format(kpi_hdl_n, big.mark=",") else "—"
```
:::
::: {.column width="25%"}
Mean HDL (mg/dL)
```{r} 
kpi_mean_hdl
```
:::
::: {.column width="25%"}
SD HDL (mg/dL)
```{r}
kpi_sd_hdl
```
:::
:::

## Task B — Visualizations 1: HDL distributions by education
```{r}
#| label: fig-hdl-hist-educ
#| fig-width: 8
#| fig-height: 5

# Histogram of HDL within each education group (faceted)
# (Assumes 'by_educ' contains mean/SD; we re-read the clean RDS for raw rows)
clean_rds <- here::here("data/clean/nhanes_clean.rds")
if (file.exists(clean_rds)) {
  d <- readRDS(clean_rds) |>
    filter(!is.na(hdl), !is.na(educ4)) |>
    mutate(educ4 = factor(educ4, levels = c("LessHS","HS/GED","SomeCollege","College+")))
  
  ggplot(d, aes(x = hdl)) +
    geom_histogram(bins = 30) +
    facet_wrap(~ educ4, scales = "free_y") +
    labs(x = "HDL (mg/dL)", y = "Count")
} else {
  # Fallback: simple bar of means if raw rows aren't available
  ggplot(by_educ, aes(educ4, mean_hdl)) +
    geom_col() +
    labs(x = NULL, y = "Mean HDL (mg/dL)")
}
```
## Task B — Table 1: Mean and SD of HDL by education

```{r}
#| label: tbl-hdl-educ

by_educ |>
  arrange(factor(educ4, levels = c("LessHS","HS/GED","SomeCollege","College+"))) |>
  mutate(
    mean_hdl = round(mean_hdl, 1),
    sd_hdl   = round(sd_hdl, 2)
  ) |>
  gt()
```

## Task B — Table 2: HDL by Food Security 
```{r}
#| label: tbl-hdl-fsq

if (exists("has_fsq_sheet") && isTRUE(has_fsq_sheet)) {
  by_fsq |>
    mutate(
      mean_hdl = round(mean_hdl, 1),
      sd_hdl   = round(sd_hdl, 2)
    ) |>
    gt()
}
```

## Methods

Files: P_DEMO (Demographics), P_HDL (HDL), P_FSQ (Food Security); merged by SEQN.

Subsample: RIDSTATR = “Both interviewed and MEC examined”; ages 21–79.

Key variables: RIDAGEYR (age), RIAGENDR (sex), DMDEDUC2→educ4 (education), INDFMPIR (PIR), LBXHDD/LBDHDDSI (HDL).